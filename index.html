<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CondoApp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- NUOVO DESIGN SYSTEM v4 (Stile App Nativa) --- */

        /* 1. Variabili e Stili di Base */
        :root {
            --bg-color: #121212;
            --surface-color: #1c1c1c;
            --surface-color-light: #2a2a2a;
            --primary-text: #FFFFFF;
            --secondary-text: #b3b3b3;
            --accent-color: #1DB954;
            --accent-color-dark: #19a34a;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            padding: 1rem 1rem 100px 1rem;
        }
        
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }


        /* 2. Componenti UI Ridisegnati */
        
        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--bg-color);
            flex-shrink: 0;
        }
        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
        }

        /* Titoli di Sezione */
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Card (Per Moduli/Form) */
        .card {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Bottoni */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }
        .btn-primary:hover {
            background-color: var(--accent-color-dark);
        }
        .btn-secondary {
            background-color: var(--surface-color-light);
            color: var(--primary-text);
        }
        .btn.w-full { width: 100%; }

        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--surface-color-light);
            border: 1px solid var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 0.8rem 1rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--primary-text);
            transition: border-color 0.2s ease;
        }
        .form-input::placeholder { color: var(--secondary-text); }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--secondary-text);
        }
        .form-textarea { resize: vertical; min-height: 100px; }

        /* Messaggi di notifica */
        .message-box {
            padding: 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: none;
        }
        .message-box.success { background-color: rgba(29, 185, 84, 0.2); color: var(--accent-color); }
        .message-box.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            border-top: 1px solid var(--surface-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1rem 0; /* Aggiunto padding-bottom per schermi con notch */
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .nav-item svg {
            width: 1.75rem;
            height: 1.75rem;
            margin-bottom: 0.25rem;
        }
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        .notification-badge {
            position: absolute;
            top: 0px;
            right: 15px;
            width: 8px;
            height: 8px;
            background-color: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-color);
        }

        /* Dashboard (Home Page) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .dashboard-item {
            cursor: pointer;
        }
        .dashboard-card {
            background-color: var(--surface-color);
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .dashboard-item:hover .dashboard-card {
             background-color: var(--surface-color-light);
        }
        .dashboard-card svg {
            width: 40%;
            height: 40%;
            color: var(--primary-text);
        }
        .dashboard-item p {
            font-weight: 600;
            text-align: left;
            padding-left: 0.5rem;
        }

        /* Pagine a Lista */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item:hover {
            background-color: var(--surface-color);
        }
        .list-item-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background-color: var(--surface-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .list-item-icon svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-text);
        }
        .list-item-content {
            flex-grow: 1;
        }
        .list-item-content .title {
            font-weight: 600;
            color: var(--primary-text);
        }
        .list-item-content .subtitle {
            font-size: 0.85rem;
            color: var(--secondary-text);
        }
        .list-item-action {
            color: var(--accent-color);
        }

        /* Filtri "Chips" */
        .filter-chips-container {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        /* Nasconde la scrollbar */
        .filter-chips-container::-webkit-scrollbar { display: none; }
        .filter-chips-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .chip {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            background-color: var(--surface-color-light);
            color: var(--primary-text);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .chip.active {
            background-color: var(--primary-text);
            color: var(--bg-color);
        }
        
        /* Badge */
        .badge {
            padding: 0.25rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: capitalize;
            display: inline-block;
        }
        .badge.priority-alta { background-color: #922b21; color: #f5b7b1; }
        .badge.priority-media { background-color: #9c640c; color: #fdebd0; }
        .badge.priority-bassa { background-color: #145a32; color: #a9dfbf; }
        .badge.status-aperta { background-color: #1b4f72; color: #a9cce3; }
        .badge.status-in-corso { background-color: #9c640c; color: #fdebd0; }
        .badge.status-chiusa { background-color: #145a32; color: #a9dfbf; }
        
        /* Poll Bar */
        .poll-option-bar {
            width: 100%;
            background-color: var(--surface-color-light);
            border-radius: 99px;
            height: 6px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .poll-option-fill {
            height: 100%;
            background: var(--secondary-text);
            border-radius: 99px;
            transition: width 0.5s ease;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .flex { display: flex; }
        .gap-4 { gap: 1rem; }
        .justify-end { justify-content: flex-end; }
        .w-full { width: 100%; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .mt-4 { margin-top: 1rem; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        // TUTTO IL JAVASCRIPT E' RIMASTO IDENTICO.
        // NON CI SONO MODIFICHE ALLA LOGICA.
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrLAomryfk-0s5Inm2XOsBrJusgmMI87E",
            authDomain: "condo-app-49255.firebaseapp.com",
            projectId: "condo-app-49255",
            storageBucket: "condo-app-49255.appspot.com",
            messagingSenderId: "485319278595",
            appId: "1:485319278595:web:2997689b234fbba4dece36",
            measurementId: "G-2SM3DH41EZ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let currentPage = 'login';
        let communicationsListener = null;

        const logActivity=async(t,e,o,a={})=>{try{await addDoc(collection(db,"activities"),{type:t,userId:e,userName:o,details:a,timestamp:serverTimestamp(),createdAt:new Date})}catch(n){console.error("Errore nel logging:",n)}};const login=async(t,e)=>await signInWithEmailAndPassword(auth,t,e);const register=async(t,e,o)=>{const a=await createUserWithEmailAndPassword(auth,t,e);return await setDoc(doc(db,"users",a.user.uid),{nome:o.nome,cognome:o.cognome,email:t,tipoUtente:o.tipoUtente,appartamento:o.appartamento||"",telefono:o.telefono||"",createdAt:(new Date).toISOString()}),await logActivity("user_registered",a.user.uid,`${o.nome} ${o.cognome}`,{userType:o.tipoUtente}),a};const logout=async()=>{communicationsListener&&(communicationsListener(),communicationsListener=null),await signOut(auth),currentUser=null,userProfile=null,navigateTo("login")};const resetPassword=async t=>await sendPasswordResetEmail(auth,t);const loadUserProfile=async t=>{if(t){const e=await getDoc(doc(db,"users",t.uid));e.exists()&&(userProfile=e.data())}};
        const navigateTo=(e)=>{userProfile?.tipoUtente==="custode"&&["dashboard","bacheca","sondaggi"].includes(e)?navigateTo("segnalazioni"):(currentPage=e,renderCurrentPage())};const getPriorityColor=t=>({alta:"priority-alta",media:"priority-media",bassa:"priority-bassa"}[t]||"priority-bassa");const getStatusColor=t=>({aperta:"status-aperta","in-corso":"status-in-corso",chiusa:"status-chiusa"}[t]||"status-aperta");
        
        const renderHeader = (title) => {
            const userInitial = userProfile?.nome ? userProfile.nome.charAt(0).toUpperCase() : 'U';
            return `
            <header class="page-header">
                <div class="user-avatar">${userInitial}</div>
                <h1 class="page-title">${title}</h1>
            </header>`;
        }

        const renderLoginPage = () => `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:1rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent-color);">CondoApp</h1>
                <h2 id="auth-title" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 2rem;">Accedi</h2>
                
                <div id="error-message" class="message-box error w-full" style="max-width:400px;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px;"></div>

                <form id="auth-form" class="space-y-4 w-full" style="max-width:400px;">
                    <div class="form-group"><label for="email" class="form-label">Email</label><input id="email" name="email" type="email" required placeholder="la-tua-email@esempio.com" class="form-input"></div>
                    <div class="form-group"><label for="password" class="form-label">Password</label><input id="password" name="password" type="password" required placeholder="••••••••" class="form-input"></div>
                    
                    <div id="register-fields" class="hidden space-y-4">
                        <div class="form-group"><label for="confirm-password" class="form-label">Conferma Password</label><input id="confirm-password" name="confirm-password" type="password" placeholder="••••••••" class="form-input"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="nome" class="form-label">Nome</label><input id="nome" name="nome" type="text" placeholder="Mario" class="form-input"></div>
                            <div class="form-group"><label for="cognome" class="form-label">Cognome</label><input id="cognome" name="cognome" type="text" placeholder="Rossi" class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="tipo-utente" class="form-label">Tipo di Utente</label>
                            <select id="tipo-utente" name="tipo-utente" class="form-select">
                                <option value="">Seleziona...</option><option value="condomino">Condomino</option><option value="amministratore">Amministratore</option>
                                <option value="custode">Custode</option><option value="consigliere">Consigliere</option><option value="fornitore">Fornitore</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="appartamento" class="form-label">Appartamento</label><input id="appartamento" name="appartamento" type="text" placeholder="es. A12" class="form-input"></div>
                        <div class="form-group"><label for="telefono" class="form-label">Telefono</label><input id="telefono" name="telefono" type="tel" placeholder="123-456-7890" class="form-input"></div>
                    </div>
                    
                    <button type="submit" id="auth-submit" class="btn btn-primary w-full">Accedi</button>
                </form>

                <div class="flex w-full justify-between mt-4" style="max-width:400px;">
                    <button type="button" id="toggle-auth" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Non hai un account? Registrati</button>
                    <button type="button" id="forgot-password" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Password dimenticata?</button>
                </div>
            </div>`;

        const renderBottomNavigation = () => {
            const isCustodian = userProfile?.tipoUtente === 'custode';

            const navItems = isCustodian
                ? `
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
                        <span>Segnala</span>
                    </a>
                    <a href="#" onclick="navigateTo('infoUtili')" class="nav-item ${currentPage === 'infoUtili' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
                        <span>Orari</span>
                    </a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
                        <span>Profilo</span>
                    </a>
                `
                : `
                    <a href="#" onclick="navigateTo('dashboard')" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
                    <a href="#" onclick="navigateTo('bacheca')" id="nav-item-bacheca" class="nav-item ${currentPage === 'bacheca' ? 'active' : ''}"><span id="bacheca-notification-badge" class="notification-badge hidden"></span><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg><span>Bacheca</span></a>
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg><span>Segnala</span></a>
                    <a href="#" onclick="navigateTo('sondaggi')" class="nav-item ${currentPage === 'sondaggi' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg><span>Sondaggi</span></a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg><span>Profilo</span></a>
                `;
            return `<nav class="bottom-nav">${navItems}</nav>`;
        };
        
        const renderDashboard = () => `
            ${renderHeader('Home')}
            <main>
                <h2 class="section-title">Accesso Rapido</h2>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('bacheca')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <p>Bacheca</p>
                    </div>
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                        <p>Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('segnalazioni')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                        <p>Segnalazioni</p>
                    </div>
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Info Utili</p>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderBacheca = () => `
            ${renderHeader('Bacheca')}
            <main>
                ${userProfile?.tipoUtente === 'amministratore' ? `<div class="card" style="margin-bottom:2rem;"><h3 class="card-title">Nuova comunicazione</h3><form id="create-communication-form" class="space-y-4"><div><label for="comm-title" class="form-label">Titolo</label><input type="text" id="comm-title" required class="form-input" placeholder="Es. Interruzione acqua"></div><div><label for="comm-content" class="form-label">Messaggio</label><textarea id="comm-content" rows="4" required class="form-textarea" placeholder="Scrivi qui..."></textarea></div><div class="flex justify-end"><button type="submit" id="publish-comm-btn" class="btn btn-primary">Pubblica</button></div></form></div>` : ''}
                <div id="communications-list" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggi = () => `
            ${renderHeader('Sondaggi')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea un Nuovo Sondaggio</h3>
                    <form id="create-poll-form" class="space-y-4">
                        <div><label class="form-label">Titolo</label><input type="text" id="poll-title" required class="form-input"></div>
                        <div><label class="form-label">Descrizione (opzionale)</label><textarea id="poll-description" rows="3" class="form-textarea"></textarea></div>
                        <div><label class="form-label">Opzioni</label><div id="poll-options-list" class="space-y-4"></div><button type="button" id="add-poll-option" class="btn btn-secondary mt-4">Aggiungi opzione</button></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Data fine</label><input type="date" id="poll-deadline" required class="form-input"></div>
                            <div><label class="form-label">Ora fine</label><input type="time" id="poll-deadline-time" required class="form-input"></div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="reset" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Crea</button></div>
                    </form>
                </div>
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSegnalazioni = () => {
             const isCustodian = userProfile?.tipoUtente === 'custode';
             const formRecipientField = isCustodian ? `<div><label class="form-label">Destinatario</label><select id="report-recipient" required class="form-select"><option value="">Seleziona...</option><option value="amministratore">Amministratore</option><option value="consigliere">Consiglieri</option><option value="condomino">Tutti i Condomini</option></select></div>` : '';
             return `
                ${renderHeader('Segnalazioni')}
                <main>
                    <div class="card" style="margin-bottom:2rem;">
                        <h3 class="card-title">Invia una Segnalazione</h3>
                        <form id="create-report-form" class="space-y-4">
                            <div><label class="form-label">Titolo</label><input type="text" id="report-title" required class="form-input" placeholder="es. Perdita d'acqua"></div>
                            <div><label class="form-label">Descrizione</label><textarea id="report-description" rows="4" required class="form-textarea" placeholder="Descrivi il problema..."></textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">Categoria</label><select id="report-category" required class="form-select"><option value="">...</option><option value="idraulico">Idraulico</option><option value="elettrico">Elettrico</option><option value="riscaldamento">Riscaldamento</option><option value="ascensore">Ascensore</option><option value="pulizie">Pulizie</option><option value="sicurezza">Sicurezza</option><option value="altro">Altro</option></select></div>
                                <div><label class="form-label">Priorità</label><select id="report-priority" required class="form-select"><option value="">...</option><option value="bassa">Bassa</option><option value="media">Media</option><option value="alta">Alta</option></select></div>
                            </div>
                            <div><label class="form-label">Ubicazione</label><input type="text" id="report-location" required class="form-input" placeholder="es. Scala A, Piano 2"></div>
                            ${formRecipientField}
                            <div class="flex justify-end pt-4"><button type="submit" class="btn btn-primary">Invia Segnalazione</button></div>
                        </form>
                    </div>
                    <div class="mt-4"><h2 class="section-title">Segnalazioni Ricevute</h2><div id="reports-main-container" class="list-container"></div></div>
                    <div class="mt-4"><h2 class="section-title">Le Tue Segnalazioni</h2><div id="reports-secondary-container" class="list-container"></div></div>
                </main>
                ${renderBottomNavigation()}
             `;
        };

        const renderProfilo = () => `
            ${renderHeader('Profilo')}
            <main>
                <div id="profile-message" class="message-box"></div>
                <div class="card">
                    <h3 class="card-title">I Tuoi Dati</h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Nome</label><input type="text" id="profile-nome" value="${userProfile?.nome || ''}" required class="form-input"></div>
                            <div><label class="form-label">Cognome</label><input type="text" id="profile-cognome" value="${userProfile?.cognome || ''}" required class="form-input"></div>
                        </div>
                        <div><label class="form-label">Email</label><input type="email" value="${currentUser?.email || ''}" required class="form-input" disabled></div>
                        <div><label class="form-label">Telefono</label><input type="tel" id="profile-telefono" value="${userProfile?.telefono || ''}" placeholder="Nessun numero" class="form-input"></div>
                        <div><label class="form-label">Appartamento</label><input type="text" id="profile-appartamento" value="${userProfile?.appartamento || ''}" placeholder="Non specificato" class="form-input"></div>
                        <div><label class="form-label">Tipo Utente</label><input type="text" value="${userProfile?.tipoUtente || ''}" class="form-input" disabled></div>
                        <button type="submit" class="btn btn-primary w-full">Salva Modifiche</button>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
        const renderInfoUtili = () => `
            ${renderHeader('Info Utili')}
            <main class="list-container">
                <div class="card">
                    <h3 class="card-title">Orari Servizio di Custodia</h3>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Lunedì - Venerdì</div><div class="subtitle">08:00 - 17:00</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Sabato</div><div class="subtitle">08:00 - 12:00</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Domenica</div><div class="subtitle">Chiuso</div></div></div>
                </div>
                <div class="card">
                    <h3 class="card-title">Numeri di Emergenza</h3>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Numero Unico Emergenze</div><div class="subtitle">112</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Amministratore (Reperibilità)</div><div class="subtitle">333 1234567</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Manutentore Ascensore</div><div class="subtitle">800 123 456</div></div></div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
        // --- LOGICA DI RENDER E HANDLER (modificata per i nuovi selettori e layout) ---

        const renderCurrentPage = () => {
            const app = document.getElementById('app');
            // La pagina di login ora ha il suo contenitore a schermo intero
            if (currentPage === 'login') {
                app.innerHTML = renderLoginPage();
                setupLoginHandlers();
                return;
            }
            app.innerHTML = `<div style="padding:1rem;">Caricamento...</div>`;
            const userType = userProfile?.tipoUtente;
            
            if (userType === 'custode' && currentPage === 'dashboard') currentPage = 'segnalazioni';

            let content = '';
            switch (currentPage) {
                case 'dashboard': content = renderDashboard(); break;
                case 'bacheca': content = renderBacheca(); break;
                case 'sondaggi': if (userType !== 'custode') { content = renderSondaggi(); } break;
                case 'segnalazioni': content = renderSegnalazioni(); break;
                case 'profilo': content = renderProfilo(); break;
                case 'infoUtili': content = renderInfoUtili(); break;
                default: content = renderLoginPage();
            }

            app.innerHTML = content;

            switch (currentPage) {
                case 'bacheca': loadCommunications(); setupBachecaHandlers(); break;
                case 'sondaggi': if (userType !== 'custode') { loadPolls(); setupPollHandlers(); } break;
                case 'segnalazioni': loadReports(); setupReportHandlers(); break;
                case 'profilo': setupProfileHandlers(); break;
            }

            if (currentPage !== 'login') {
                checkForNewCommunications();
            }
        };

        const setupLoginHandlers=()=>{let e=!1;const t=document.getElementById("toggle-auth"),o=document.getElementById("auth-title"),n=document.getElementById("auth-submit"),d=document.getElementById("register-fields"),i=document.getElementById("auth-form"),r=document.getElementById("forgot-password");t?.addEventListener("click",t=>{t.preventDefault(),e=!e,o.textContent=e?"Registrati":"Accedi",n.textContent=e?"Registrati":"Accedi",t.target.textContent=e?"Hai già un account? Accedi":"Non hai un account? Registrati",d.classList.toggle("hidden",!e),r.classList.toggle("hidden",e)}),i?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("email").value,n=document.getElementById("password").value,d=document.getElementById("error-message"),r=document.getElementById("success-message");d.style.display="none",r.style.display="none";try{if(e){const t=document.getElementById("confirm-password").value,i=document.getElementById("nome").value,s=document.getElementById("cognome").value,a=document.getElementById("tipo-utente").value,c=document.getElementById("appartamento").value,l=document.getElementById("telefono").value;if(n!==t)throw new Error("Le password non coincidono");if(!i||!s||!a)throw new Error("Compila tutti i campi obbligatori");await register(o,n,{nome:i,cognome:s,tipoUtente:a,appartamento:c,telefono:l}),r.textContent="Registrazione completata! Ora puoi accedere.",r.style.display="block"}else await login(o,n)}catch(m){d.textContent=m.message,d.style.display="block"}}),r?.addEventListener("click",async t=>{t.preventDefault();const e=document.getElementById("email").value,o=document.getElementById("error-message"),n=document.getElementById("success-message");if(!e)return o.textContent="Inserisci la tua email per reimpostare la password",void(o.style.display="block");try{await resetPassword(e),n.textContent="Email di reset password inviata!",n.style.display="block",o.style.display="none"}catch(d){o.textContent=d.message,o.style.display="block"}})};
        const setupBachecaHandlers=()=>{const e=document.getElementById("create-communication-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("comm-title"),n=document.getElementById("comm-content"),d=document.getElementById("publish-comm-btn"),i=o.value.trim(),r=n.value.trim();if(!i||!r)return alert("Compila titolo e messaggio.");d.disabled=!0,d.textContent="...";try{await addDoc(collection(db,"communications"),{title:i,content:r,createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()}),await logActivity("communication_posted",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:i}),e.reset()}catch(c){console.error("Errore:",c),alert("Si è verificato un errore.")}finally{d.disabled=!1,d.textContent="Pubblica"}})};
        const setupPollHandlers=()=>{const e=document.getElementById("create-poll-form");if(!e)return;const t=document.getElementById("poll-options-list"),o=document.getElementById("add-poll-option");function n(e=""){const o=document.createElement("div");o.className="flex items-center gap-2",o.innerHTML=`<input type="text" class="form-input" style="flex:1" required placeholder="Testo opzione" value="${e}"><button type="button" class="btn-remove-option" style="background:var(--surface-color-light); border:none; color:var(--primary-text); width:36px; height:36px; border-radius:50%; cursor:pointer;">−</button>`,o.querySelector(".btn-remove-option").onclick=()=>{t.removeChild(o),t.childElementCount<2&&n()},t.appendChild(o)}0===t.childElementCount&&(n(),n()),o.onclick=e=>{e.preventDefault(),n()},e.addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("poll-title").value,t=document.getElementById("poll-description").value,d=document.getElementById("poll-deadline").value,i=document.getElementById("poll-deadline-time").value,l=e.querySelectorAll('#poll-options-list input[type="text"]'),r=Array.from(l).map(e=>e.value.trim()).filter(Boolean).map(e=>({text:e,votes:0}));if(r.length<2)return alert("Inserisci almeno due opzioni.");if(!d||!i)return alert("Inserisci una data e un'ora di scadenza.");const c=`${d}T${i}`,s=new Date(c);try{await addDoc(collection(db,"polls"),{title:n,description:t,options:r,deadline:s,createdBy:userProfile.nome+" "+userProfile.cognome,createdById:currentUser.uid,createdAt:serverTimestamp(),voters:[]}),await logActivity("poll_created",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:n}),e.reset()}catch(p){console.error("Errore:",p)}}),e.addEventListener("reset",()=>{setTimeout(()=>{t.innerHTML="",n(),n()},0)})};
        const setupReportHandlers = () => { const e=document.getElementById("create-report-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("report-title").value,n=document.getElementById("report-description").value,i=document.getElementById("report-category").value,d=document.getElementById("report-priority").value,r=document.getElementById("report-location").value;if(!o||!n||!i||!d||!r)return alert("Compila tutti i campi.");const c={title:o,description:n,category:i,priority:d,location:r,status:"aperta",createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()},l=document.getElementById("report-recipient");l&&l.value?c.recipientType=l.value:c.recipientType="management";try{await addDoc(collection(db,"reports"),c),await logActivity("report_created",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:o,priority:d}),e.reset()}catch(a){console.error("Errore:",a)}})};
        const setupProfileHandlers=()=>{const e=document.getElementById("profile-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("profile-nome").value,n=document.getElementById("profile-cognome").value,d=document.getElementById("profile-telefono").value,i=document.getElementById("profile-appartamento").value;try{await updateDoc(doc(db,"users",currentUser.uid),{nome:o,cognome:n,telefono:d,appartamento:i}),await loadUserProfile(currentUser),showProfileMessage("success","Profilo aggiornato!")}catch(r){showProfileMessage("error",`Errore: ${r.message}`)}})};
        const showProfileMessage=(e,t)=>{const o=document.getElementById("profile-message");o&&(o.className=`message-box ${e}`,o.textContent=t,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3))};
        
        const loadCommunications = () => {
            const listEl = document.getElementById("communications-list");
            if (!listEl) return;
            const q = query(collection(db, "communications"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                listEl.innerHTML = snapshot.empty ? `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessuna comunicazione.</p>` : snapshot.docs.map(docSnap => {
                    const comm = docSnap.data();
                    if (!comm.createdAt) return "";
                    const dateFormatted = comm.createdAt.toDate().toLocaleString("it-IT", { day: "2-digit", month: "short", year: "numeric"});
                    return `
                    <div class="list-item">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${comm.title}</div>
                            <div class="subtitle">${comm.content.substring(0, 50)}...</div>
                            <div class="subtitle" style="font-size:0.75rem; margin-top:4px;">${comm.createdBy} - ${dateFormatted}</div>
                        </div>
                    </div>`;
                }).join("");
                if (currentPage === 'bacheca' && !snapshot.empty) {
                    localStorage.setItem(`lastSeenComm_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                    updateNotificationUI(false);
                }
            });
        };

        const loadPolls = () => {
            const container = document.getElementById("polls-container");
            if (!container) return;
            const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                container.innerHTML = snapshot.empty ? `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessun sondaggio.</p>` : snapshot.docs.map(docSnap => {
                    const poll = docSnap.data();
                    if (!poll.deadline) return "";
                    const deadline = poll.deadline.toDate();
                    const isExpired = deadline < new Date();
                    const hasVoted = poll.voters && poll.voters.some(v => v.uid === currentUser.uid);
                    const totalVotes = poll.options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
                    return `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <div class="list-item" style="padding:0; margin-bottom:1rem;">
                            <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                            <div class="list-item-content">
                                <div class="title">${poll.title}</div>
                                <div class="subtitle">${isExpired ? "Sondaggio chiuso" : "Sondaggio attivo"} ${hasVoted ? "· Hai votato" : ""}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${poll.options.map((option, index) => {
                                const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                return `
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                        <span class="font-medium">${option.text}</span>
                                        <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                    </div>
                                    <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                    ${!isExpired && !hasVoted ? `<button onclick="voteOnPoll('${docSnap.id}', ${index})" class="btn btn-secondary" style="width:100%; margin-top:0.75rem;">Vota per "${option.text}"</button>` : ''}
                                </div>`
                            }).join("")}
                        </div>
                    </div>`;
                }).join("");
            });
        };

        const loadReports = () => {
            const mainContainer = document.getElementById('reports-main-container');
            const secondaryContainer = document.getElementById('reports-secondary-container');
            if (!mainContainer || !secondaryContainer) return;
            const renderReportCardHTML=(e,t)=>{if(!e.createdAt)return"";const o=e.createdAt.toDate().toLocaleString("it-IT",{day:"2-digit",month:"short"});const a=["amministratore","custode","consigliere","fornitore"].includes(userProfile?.tipoUtente);const n=a,d="management"===e.recipientType&&n||e.recipientType===userProfile?.tipoUtente||"consigliere"===e.recipientType&&"consigliere"===userProfile?.tipoUtente;return`<div class="list-item"><div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div><div class="list-item-content"><div class="title">${e.title}</div><div class="subtitle" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.25rem;"><span class="badge ${getPriorityColor(e.priority)}">${e.priority}</span><span class="badge ${getStatusColor(e.status)}">${e.status}</span></div></div>${a&&"chiusa"!==e.status&&d?`<div class="list-item-action"><button onclick="updateReportStatus('${t}','${"aperta"===e.status?"in-corso":"chiusa"}')" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.8rem;">${"aperta"===e.status?"Prendi":"Chiudi"}</button></div>`:""}</div>`};
            const renderSnapshot=(e,t,o)=>{if(t.empty)return void(e.innerHTML=`<p style="color:var(--secondary-text); padding: 1rem 0;">${o}</p>`);const a=t.docs.sort((e,t)=>{const o=e.data().createdAt?.toMillis()||0,n=t.data().createdAt?.toMillis()||0;return n-o});e.innerHTML=a.map(e=>renderReportCardHTML(e.data(),e.id)).join("")};
            const userType=userProfile.tipoUtente,userId=currentUser.uid,qSent=query(collection(db,"reports"),where("createdById","==",userId));onSnapshot(qSent,s=>renderSnapshot(secondaryContainer,s,"Non hai inviato segnalazioni."));let qToManage;if(["amministratore","custode","consigliere","fornitore"].includes(userType)){qToManage=query(collection(db,"reports"),orderBy("createdAt","desc"));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione ricevuta."))}else{qToManage=query(collection(db,"reports"),where("recipientType","in",["management","condomino"]));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione pubblica."))}
        };

        const voteOnPoll=async(e,t)=>{try{const o=doc(db,"polls",e),n=await getDoc(o);if(!n.exists())return;const i=n.data();if(i.deadline.toDate()<new Date)return alert("Sondaggio scaduto.");if(i.voters?.some(e=>e.uid===currentUser.uid))return alert("Hai già votato!");const d=[...i.options];d[t].votes=(d[t].votes||0)+1;const a=i.options[t].text,r=[...i.voters||[],{uid:currentUser.uid,name:`${userProfile.nome} ${userProfile.cognome}`,vote:a}];await updateDoc(o,{options:d,voters:r}),await logActivity("poll_voted",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{pollTitle:i.title,option:a})}catch(l){console.error("Errore nel voto:",l)}};
        const updateReportStatus=async(e,t)=>{try{await updateDoc(doc(db,"reports",e),{status:t,updatedAt:serverTimestamp()}),await logActivity("report_updated",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{reportId:e,newStatus:t})}catch(o){console.error("Errore nell'aggiornamento:",o)}};
        const updateNotificationUI=e=>{const t=document.getElementById("bacheca-notification-badge");t?.classList.toggle("hidden",!e)};
        const checkForNewCommunications=()=>{if(!currentUser||"custode"===userProfile?.tipoUtente)return;communicationsListener&&communicationsListener();const e=parseInt(localStorage.getItem(`lastSeenComm_${currentUser.uid}`),10)||0,t=new Date(e),o=query(collection(db,"communications"),where("createdAt",">",t));communicationsListener=onSnapshot(o,e=>{updateNotificationUI(!e.empty)})};
        
        window.navigateTo = navigateTo;
        window.logout = logout;
        window.voteOnPoll = voteOnPoll;
        window.updateReportStatus = updateReportStatus;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user);
                const isCustodian = userProfile?.tipoUtente === 'custode';
                const landingPage = isCustodian ? 'segnalazioni' : 'dashboard';
                navigateTo(currentPage === 'login' || !currentPage ? landingPage : currentPage);
            } else {
                if (communicationsListener) communicationsListener();
                currentUser = null; userProfile = null;
                navigateTo('login');
            }
        });
    </script>
</body>
</html>
