<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Con-bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- NUOVO DESIGN SYSTEM v4 (Stile App Nativa) --- */

        /* 1. Variabili e Stili di Base */
        :root {
            --bg-color: #121212;
            --surface-color: #1c1c1c;
            --surface-color-light: #2a2a2a;
            --primary-text: #FFFFFF;
            --secondary-text: #b3b3b3;
            --accent-color: #1DB954;
            --accent-color-dark: #19a34a;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            padding: 1rem 1rem 100px 1rem;
        }
        
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }


        /* 2. Componenti UI Ridisegnati */
        
        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--bg-color);
            flex-shrink: 0;
        }
        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
            line-height: 1.2;
        }
        .page-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
            text-transform: capitalize;
        }

        /* Titoli di Sezione */
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Card (Per Moduli/Form) */
        .card {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Bottoni */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }
        .btn-primary:hover {
            background-color: var(--accent-color-dark);
        }
        .btn-secondary {
            background-color: var(--surface-color-light);
            color: var(--primary-text);
        }
        .btn.w-full { width: 100%; }

        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--surface-color-light);
            border: 1px solid var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 0.8rem 1rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--primary-text);
            transition: border-color 0.2s ease;
        }
        .form-input::placeholder { color: var(--secondary-text); }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--secondary-text);
        }
        .form-textarea { resize: vertical; min-height: 100px; }

        /* Stile per pulsante mostra/nascondi password */
        .password-toggle-container {
            position: relative;
        }
        .password-toggle-btn {
            position: absolute;
            right: 0.2rem;
            top: 50%;
            transform: translateY(calc(-50% + 0.75rem)); /* CORREZIONE APPLICATA QUI */
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .password-toggle-btn svg {
            width: 22px;
            height: 22px;
        }

        /* --- MODIFICA INIZIO: Stili per selezione proprietà in registrazione --- */
        .property-selection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: var(--bg-color);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
        }
        .property-selection-item label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
        }
        .property-selection-item .group-select {
            flex-basis: 160px;
            flex-shrink: 0;
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
        }
        /* --- MODIFICA FINE --- */

        /* Messaggi di notifica */
        .message-box {
            padding: 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: none;
        }
        .message-box.success { background-color: rgba(29, 185, 84, 0.2); color: var(--accent-color); }
        .message-box.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            border-top: 1px solid var(--surface-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1rem 0; /* Aggiunto padding-bottom per schermi con notch */
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .nav-item svg {
            width: 1.75rem;
            height: 1.75rem;
            margin-bottom: 0.25rem;
        }
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        .notification-badge {
            position: absolute;
            top: 0px;
            right: 15px;
            width: 8px;
            height: 8px;
            background-color: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-color);
        }

        /* Dashboard (Home Page) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .dashboard-item {
            cursor: pointer;
        }
        .dashboard-card {
            background-color: var(--surface-color);
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .dashboard-item:hover .dashboard-card {
             background-color: var(--surface-color-light);
        }
        .dashboard-card svg {
            width: 40%;
            height: 40%;
            color: var(--primary-text);
        }
        .dashboard-item p {
            font-weight: 600;
            text-align: left;
            padding-left: 0.5rem;
        }

        /* Pagine a Lista */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item:hover {
            background-color: var(--surface-color);
        }
        .list-item-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background-color: var(--surface-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .list-item-icon svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-text);
        }
        .list-item-content {
            flex-grow: 1;
            min-width: 0; /* Fix per flexbox overflow */
        }
        .list-item-content .title {
            font-weight: 600;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item-content .subtitle {
            font-size: 0.85rem;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item-action {
            color: var(--accent-color);
            flex-shrink: 0;
        }

        /* Filtri "Chips" */
        .filter-chips-container {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        /* Nasconde la scrollbar */
        .filter-chips-container::-webkit-scrollbar { display: none; }
        .filter-chips-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .chip {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            background-color: var(--surface-color-light);
            color: var(--primary-text);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .chip.active {
            background-color: var(--primary-text);
            color: var(--bg-color);
        }
        
        /* Badge */
        .badge {
            padding: 0.25rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: capitalize;
            display: inline-block;
        }
        .badge.priority-alta { background-color: #922b21; color: #f5b7b1; }
        .badge.priority-media { background-color: #9c640c; color: #fdebd0; }
        .badge.priority-bassa { background-color: #145a32; color: #a9dfbf; }
        .badge.status-aperta { background-color: #1b4f72; color: #a9cce3; }
        .badge.status-in-corso { background-color: #9c640c; color: #fdebd0; }
        .badge.status-chiusa { background-color: #145a32; color: #a9dfbf; }
        
        /* Poll Bar */
        .poll-option-bar {
            width: 100%;
            background-color: var(--surface-color-light);
            border-radius: 99px;
            height: 6px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .poll-option-fill {
            height: 100%;
            background: var(--secondary-text);
            border-radius: 99px;
            transition: width 0.5s ease;
        }

        /* Stili per il Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            cursor: pointer;
        }
        .modal-content {
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            cursor: default;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body p {
            line-height: 1.6;
            white-space: pre-wrap; /* Mantiene la formattazione del testo */
        }
        .modal-body .voter-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--surface-color-light);
        }
        .modal-body .voter-item:last-child {
            border-bottom: none;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .items-center { align-items: center; }
        .justify-end { justify-content: flex-end; }
        .w-full { width: 100%; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .mt-4 { margin-top: 1rem; }

        /* Stili per Tabella Dati */
        .data-table-container {
            overflow-x: auto; /* Per responsività su schermi piccoli */
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--surface-color-light);
            white-space: nowrap;
        }
        .data-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
        }
        .data-table td {
            font-size: 0.95rem;
        }
        .data-table tr:hover {
            background-color: var(--surface-color-light);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <div id="modal-container" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title"></h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, where, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrLAomryfk-0s5Inm2XOsBrJusgmMI87E",
            authDomain: "condo-app-49255.firebaseapp.com",
            projectId: "condo-app-49255",
            storageBucket: "condo-app-49255.appspot.com",
            messagingSenderId: "485319278595",
            appId: "1:485319278595:web:2997689b234fbba4dece36",
            measurementId: "G-2SM3DH41EZ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let currentPage = 'login';
        let communicationsListener = null;

        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-4 .68l1.64 1.64C9.74 7.13 10.82 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L21.73 23 20.46 21.73 4.54 5.81 3.27 4.54 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;

        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const showModal = (title, contentHtml) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modalContainer.classList.remove('hidden');
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };

        modalCloseBtn.addEventListener('click', hideModal);
        modalContainer.addEventListener('click', (event) => {
            if (event.target === modalContainer) {
                hideModal();
            }
        });
        
        const logActivity=async(t,e,o,a={})=>{try{await addDoc(collection(db,"activities"),{type:t,userId:e,userName:o,details:a,timestamp:serverTimestamp(),createdAt:new Date})}catch(n){console.error("Errore nel logging:",n)}};
        const register=async(t,e,o)=>{const a=await createUserWithEmailAndPassword(auth,t,e);const totalMillesimi=o.proprieta.reduce(((sum,prop)=>sum+(parseFloat(prop.millesimi)||0)),0);return await setDoc(doc(db,"users",a.user.uid),{nome:o.nome,cognome:o.cognome,email:t,tipoUtente:o.tipoUtente,proprieta:o.proprieta||[],telefono:o.telefono||"",millesimiTotali:totalMillesimi,createdAt:(new Date).toISOString()}),await logActivity("user_registered",a.user.uid,`${o.nome} ${o.cognome}`,{userType:o.tipoUtente}),a};
        const login=async(t,e)=>await signInWithEmailAndPassword(auth,t,e);
        const logout=async()=>{communicationsListener&&(communicationsListener(),communicationsListener=null),await signOut(auth),currentUser=null,userProfile=null,navigateTo("login")};
        const resetPassword=async t=>await sendPasswordResetEmail(auth,t);
        const loadUserProfile=async t=>{if(t){const e=await getDoc(doc(db,"users",t.uid));e.exists()&&(userProfile=e.data())}};
        
        const navigateTo=(e)=>{
            const userType = userProfile?.tipoUtente;
            if (['supervisore', 'adm'].includes(userType) && ['userManagement', 'gestioneGruppi', 'importazione'].includes(e)) {
                 currentPage = e;
                 renderCurrentPage();
                 return;
            }
            if(userType==="custode"&&["dashboard","bacheca","sondaggi"].includes(e)){
                navigateTo("segnalazioni");
            } else {
                currentPage=e,renderCurrentPage();
            }
        };
        
        const getPriorityColor=t=>({alta:"priority-alta",media:"priority-media",bassa:"priority-bassa"}[t]||"priority-bassa");
        const getStatusColor=t=>({aperta:"status-aperta","in-corso":"status-in-corso",chiusa:"status-chiusa"}[t]||"status-aperta");
        
        const renderHeader = (title) => {
            const userInitial = userProfile?.nome ? userProfile.nome.charAt(0).toUpperCase() : 'U';
            const userType = userProfile?.tipoUtente || '';
            return `
            <header class="page-header">
                <div class="user-avatar">${userInitial}</div>
                <div>
                    <h1 class="page-title">${title}</h1>
                    <p class="page-subtitle">${userType}</p>
                </div>
            </header>`;
        }

        const renderLoginPage = () => `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:1rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent-color);">Con-bridge</h1>
                <h2 id="auth-title" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 2rem;">Accedi</h2>
                
                <div id="error-message" class="message-box error w-full" style="max-width:400px;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px;"></div>

                <form id="auth-form" class="space-y-4 w-full" style="max-width:400px;">
                    <div class="form-group"><label for="email" class="form-label">Email</label><input id="email" name="email" type="email" required placeholder="la-tua-email@esempio.com" class="form-input"></div>
                    
                    <div class="form-group password-toggle-container">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" name="password" type="password" required placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                        <button type="button" class="password-toggle-btn" data-target="password">${eyeIcon}</button>
                    </div>
                    
                    <div id="register-fields" class="hidden space-y-4">
                        <div class="form-group password-toggle-container">
                            <label for="confirm-password" class="form-label">Conferma Password</label>
                            <input id="confirm-password" name="confirm-password" type="password" placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                            <button type="button" class="password-toggle-btn" data-target="confirm-password">${eyeIcon}</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="nome" class="form-label">Nome</label><input id="nome" name="nome" type="text" placeholder="Mario" class="form-input"></div>
                            <div class="form-group"><label for="cognome" class="form-label">Cognome</label><input id="cognome" name="cognome" type="text" placeholder="Rossi" class="form-input"></div>
                        </div>
                        <input id="tipo-utente" name="tipo-utente" type="hidden" value="condomino">
                        <p style="font-size: 0.8rem; color: var(--secondary-text); text-align: center; margin-top: -0.5rem; margin-bottom: 1rem;">La registrazione è consentita solo ai condomini. Per altri ruoli, contattare il supervisore.</p>
                        <div class="form-group">
                            <label for="nominativo-select" class="form-label">NOMINATIVO PROPRIETARIO</label>
                            <input id="nominativo-select" name="nominativo-select" list="nominativi-list" type="text" placeholder="Cerca e seleziona il proprietario..." class="form-input" autocomplete="off">
                            <datalist id="nominativi-list"></datalist>
                        </div>

                        <!-- --- MODIFICA INIZIO: Contenitore per la selezione delle proprietà e dei gruppi --- -->
                        <div id="property-selection-wrapper" class="form-group hidden" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                             <label class="form-label" style="margin-bottom: 1rem;">Seleziona le tue Unità e assegna un Gruppo</label>
                             <div id="property-items-container" class="space-y-4">
                                 <!-- Le proprietà con i dropdown verranno aggiunte dinamicamente qui -->
                             </div>
                        </div>
                        <!-- --- MODIFICA FINE --- -->

                        <div class="form-group">
                            <label class="form-label">ELENCO UNITA' IMMOBILIARI DEL PROPRIETARIO</label>
                            <div id="selection-summary" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); min-height: 60px; color: var(--secondary-text);">
                                Seleziona un nominativo per continuare...
                            </div>
                        </div>
                        <div class="form-group"><label for="telefono" class="form-label">Telefono</label><input id="telefono" name="telefono" type="tel" placeholder="123-456-7890" class="form-input"></div>
                    </div>
                    
                    <button type="submit" id="auth-submit" class="btn btn-primary w-full">Accedi</button>
                </form>

                <div class="flex w-full mt-4" style="max-width:400px; justify-content: space-between;">
                    <button type="button" id="toggle-auth" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Non hai un account? Registrati</button>
                    <button type="button" id="forgot-password" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Password dimenticata?</button>
                </div>
            </div>`;

        const renderBottomNavigation = () => {
            const isCustodian = userProfile?.tipoUtente === 'custode';

            const navItems = isCustodian
                ? `
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
                        <span>Segnala</span>
                    </a>
                    <a href="#" onclick="navigateTo('infoUtili')" class="nav-item ${currentPage === 'infoUtili' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
                        <span>Orari</span>
                    </a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
                        <span>Profilo</span>
                    </a>
                `
                : `
                    <a href="#" onclick="navigateTo('dashboard')" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
                    <a href="#" onclick="navigateTo('bacheca')" id="nav-item-bacheca" class="nav-item ${currentPage === 'bacheca' ? 'active' : ''}"><span id="bacheca-notification-badge" class="notification-badge hidden"></span><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg><span>Bacheca</span></a>
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg><span>Segnala</span></a>
                    <a href="#" onclick="navigateTo('sondaggi')" class="nav-item ${currentPage === 'sondaggi' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg><span>Sondaggi</span></a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg><span>Profilo</span></a>
                `;
            return `<nav class="bottom-nav">${navItems}</nav>`;
        };
        
        const renderDashboard = () => {
            let extraItems = '';
            if (['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                extraItems = `
                    <div onclick="navigateTo('userManagement')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 17v-2c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H5v-2c0-2.21 1.79-4 4-4h2c2.21 0 4 1.79 4 4v2h-2zm-4-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
                        <p>Gestione Utenti</p>
                    </div>
                    <div onclick="navigateTo('gestioneGruppi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 4v4h4V4h-4m6 12v4h4v-4h-4m-6 0v4h4v-4h-4m6-6v4h4v-4h-4m-6 0v4h4v-4h-4m-6-6v4h4V4H4m6 6v4h4v-4h-4M4 16v4h4v-4H4m14-2h2v-4h-2v4m0 6h2v-4h-2v4m-12-2h2v-4H6v4m0 6h2v-4H6v4M2 2v20h20V2H2z"/></svg></div>
                        <p>Gestione Gruppi</p>
                    </div>
                     <div onclick="navigateTo('importazione')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M5,17.59L15.59,7H9V5H19V15H17V8.41L6.41,19L5,17.59Z"/></svg></div>
                        <p>Importa Dati</p>
                    </div>
                `;
            }
            return `
            ${renderHeader('Home')}
            <main>
                <h2 class="section-title">Accesso Rapido</h2>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('bacheca')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <p>Bacheca</p>
                    </div>
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                        <p>Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('segnalazioni')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                        <p>Segnalazioni</p>
                    </div>
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Info Utili</p>
                    </div>
                    ${extraItems}
                </div>
                <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;}

        const renderBacheca = () => `
            ${renderHeader('Bacheca')}
            <main>
                ${(userProfile?.tipoUtente === 'amministratore' || userProfile?.tipoUtente === 'supervisore') ? `<div class="card" style="margin-bottom:2rem;"><h3 class="card-title">Nuova comunicazione</h3><form id="create-communication-form" class="space-y-4"><div><label for="comm-title" class="form-label">Titolo</label><input type="text" id="comm-title" required class="form-input" placeholder="Es. Interruzione acqua"></div><div><label for="comm-content" class="form-label">Messaggio</label><textarea id="comm-content" rows="4" required class="form-textarea" placeholder="Scrivi qui..."></textarea></div><div class="flex justify-end"><button type="submit" id="publish-comm-btn" class="btn btn-primary">Pubblica</button></div></form></div>` : ''}
                <div id="communications-list" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggi = () => `
            ${renderHeader('Sondaggi')}
            <main>
                ${(userProfile?.tipoUtente === 'amministratore' || userProfile?.tipoUtente === 'supervisore') ? `<div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea un Nuovo Sondaggio</h3>
                    <form id="create-poll-form" class="space-y-4">
                        <div><label class="form-label">Titolo</label><input type="text" id="poll-title" required class="form-input"></div>
                        <div><label class="form-label">Descrizione (opzionale)</label><textarea id="poll-description" rows="3" class="form-textarea"></textarea></div>
                        <div><label class="form-label">Opzioni</label><div id="poll-options-list" class="space-y-4"></div><button type="button" id="add-poll-option" class="btn btn-secondary mt-4">Aggiungi opzione</button></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Data fine</label><input type="date" id="poll-deadline" required class="form-input"></div>
                            <div><label class="form-label">Ora fine</label><input type="time" id="poll-deadline-time" required class="form-input"></div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="reset" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Crea</button></div>
                    </form>
                </div>` : ''}
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSegnalazioni = () => {
             const isCustodian = userProfile?.tipoUtente === 'custode';
             const formRecipientField = isCustodian ? `<div><label class="form-label">Destinatario</label><select id="report-recipient" required class="form-select"><option value="">Seleziona...</option><option value="amministratore">Amministratore</option><option value="consigliere">Consiglieri</option><option value="condomino">Tutti i Condomini</option></select></div>` : '';
             return `
                ${renderHeader('Segnalazioni')}
                <main>
                    <div class="card" style="margin-bottom:2rem;">
                        <h3 class="card-title">Invia una Segnalazione</h3>
                        <form id="create-report-form" class="space-y-4">
                            <div><label class="form-label">Titolo</label><input type="text" id="report-title" required class="form-input" placeholder="es. Perdita d'acqua"></div>
                            <div><label class="form-label">Descrizione</label><textarea id="report-description" rows="4" required class="form-textarea" placeholder="Descrivi il problema..."></textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">Categoria</label><select id="report-category" required class="form-select"><option value="">...</option><option value="idraulico">Idraulico</option><option value="elettrico">Elettrico</option><option value="riscaldamento">Riscaldamento</option><option value="ascensore">Ascensore</option><option value="pulizie">Pulizie</option><option value="sicurezza">Sicurezza</option><option value="altro">Altro</option></select></div>
                                <div><label class="form-label">Priorità</label><select id="report-priority" required class="form-select"><option value="">...</option><option value="bassa">Bassa</option><option value="media">Media</option><option value="alta">Alta</option></select></div>
                            </div>
                            <div><label class="form-label">Ubicazione</label><input type="text" id="report-location" required class="form-input" placeholder="es. Scala A, Piano 2"></div>
                            ${formRecipientField}
                            <div class="flex justify-end pt-4"><button type="submit" class="btn btn-primary">Invia Segnalazione</button></div>
                        </form>
                    </div>
                    <div class="mt-4"><h2 class="section-title">Segnalazioni Ricevute</h2><div id="reports-main-container" class="list-container"></div></div>
                    <div class="mt-4"><h2 class="section-title">Le Tue Segnalazioni</h2><div id="reports-secondary-container" class="list-container"></div></div>
                </main>
                ${renderBottomNavigation()}
             `;
        };

        const renderProfilo = () => `
            ${renderHeader('Profilo')}
            <main>
                <div id="profile-message" class="message-box"></div>
                <div class="card">
                    <h3 class="card-title">I Tuoi Dati</h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Nome</label><input type="text" id="profile-nome" value="${userProfile?.nome || ''}" required class="form-input"></div>
                            <div><label class="form-label">Cognome</label><input type="text" id="profile-cognome" value="${userProfile?.cognome || ''}" required class="form-input"></div>
                        </div>
                        <div><label class="form-label">Email</label><input type="email" value="${currentUser?.email || ''}" required class="form-input" disabled></div>
                        <div><label class="form-label">Telefono</label><input type="tel" id="profile-telefono" value="${userProfile?.telefono || ''}" placeholder="Nessun numero" class="form-input"></div>
                        <div class="form-group">
                            <label class="form-label">Le Tue Proprietà</label>
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                                ${userProfile?.proprieta && userProfile.proprieta.length > 0
                                    ? `<ul>${userProfile.proprieta.map(p => `<li style="list-style-type: disc; margin-left: 20px;">${p.interno} (${(p.millesimi || 0).toFixed(2)} ‰) ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')}</ul>
                                       <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                       <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(userProfile.millesimiTotali || 0).toFixed(2)} ‰</span></div>`
                                    : '<p style="color:var(--secondary-text);">Nessuna proprietà associata.</p>'
                                }
                            </div>
                        </div>
                        <div><label class="form-label">Tipo Utente</label><input type="text" value="${userProfile?.tipoUtente || ''}" class="form-input" disabled></div>
                        <button type="submit" class="btn btn-primary w-full">Salva Nome e Telefono</button>
                    </form>
                </div>
                 <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
        const renderInfoUtili = () => `
            ${renderHeader('Info Utili')}
            <main class="list-container">
                <div class="card">
                    <h3 class="card-title">Orari Servizio di Custodia</h3>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Lunedì - Venerdì</div><div class="subtitle">08:00 - 17:00</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Sabato</div><div class="subtitle">08:00 - 12:00</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Domenica</div><div class="subtitle">Chiuso</div></div></div>
                </div>
                <div class="card">
                    <h3 class="card-title">Numeri di Emergenza</h3>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Numero Unico Emergenze</div><div class="subtitle">112</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Amministratore (Reperibilità)</div><div class="subtitle">333 1234567</div></div></div>
                    <div class="list-item" style="cursor:default;"><div class="list-item-content"><div class="title">Manutentore Ascensore</div><div class="subtitle">800 123 456</div></div></div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

                const renderImportazione = () => `
            ${renderHeader('Importazione Dati')}
            <main>
                <!-- Vista per i dati già salvati -->
                <div id="saved-data-view" class="hidden">
                    <div class="card">
                         <div class="flex items-center justify-between">
                            <h3 class="card-title" style="margin-bottom: 0;">Dati Attualmente Salvati</h3>
                            <button id="show-upload-form-btn" class="btn btn-secondary">Carica Nuovo</button>
                        </div>
                        <div id="saved-data-info" class="mt-4" style="color: var(--secondary-text); font-size: 0.9rem;"></div>
                    </div>
                    <div class="card mt-4">
                        <div id="saved-data-table-container" class="data-table-container">
                            <p>Caricamento dati...</p>
                        </div>
                    </div>
                </div>

                <!-- Vista per il caricamento di un nuovo file -->
                <div id="upload-view" class="hidden">
                     <div class="card">
                        <h3 class="card-title">Carica Nuovo File Excel</h3>
                        <p class="form-label" style="margin-bottom: 1rem; color: var(--secondary-text);">
                            Seleziona un file in formato .xlsx o .xls. Il nuovo file sostituirà i dati esistenti.
                        </p>
                        <div class="form-group">
                            <input type="file" id="excel-file-input" class="form-input" accept=".xlsx, .xls">
                        </div>
                        <div id="message-import" class="message-box"></div>
                        <div id="save-button-container" class="hidden mt-4">
                            <button id="save-imported-data-btn" class="btn btn-primary w-full">Salva e Sostituisci Dati</button>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <h3 class="card-title">Anteprima Dati</h3>
                        <div id="excel-table-container" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato.</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
        const renderGestioneGruppi = () => `
            ${renderHeader('Gestione Gruppi')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea Condominio Parziale</h3>
                    <form id="create-partial-condo-form" class="flex gap-4">
                        <div class="form-group" style="flex-grow:1; margin-bottom:0;">
                            <label for="partial-condo-name" class="form-label hidden">Nome Gruppo</label>
                            <input type="text" id="partial-condo-name" required class="form-input" placeholder="Es. Scala A, Box, Giardino...">
                        </div>
                        <button type="submit" class="btn btn-primary">Crea</button>
                    </form>
                </div>

                <h2 class="section-title">Elenco Condomini Parziali</h2>
                <div id="partial-condos-list" class="list-container">
                    <p>Caricamento...</p>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagement = () => `
            ${renderHeader('Gestione Utenti')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea Nuovo Utente</h3>
                    <div id="admin-create-user-message" class="message-box"></div>
                    <form id="admin-create-user-form" class="space-y-4">
                        <div class="form-group">
                            <label for="admin-email" class="form-label">Email</label>
                            <input id="admin-email" type="email" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="admin-password" class="form-label">Password Temporanea</label>
                            <input id="admin-password" type="password" required class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="admin-nome" class="form-label">Nome</label><input id="admin-nome" type="text" required class="form-input"></div>
                            <div class="form-group"><label for="admin-cognome" class="form-label">Cognome</label><input id="admin-cognome" type="text" required class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="admin-tipo-utente" class="form-label">Tipo di Utente</label>
                            <select id="admin-tipo-utente" required class="form-select">
                                <option value="">Seleziona...</option>
                                <option value="condomino">Condomino</option>
                                <option value="amministratore">Amministratore</option>
                                <option value="custode">Custode</option>
                                <option value="consigliere">Consigliere</option>
                                <option value="fornitore">Fornitore</option>
                                <option value="supervisore">Supervisore</option>
                                <option value="adm">Admin (ADM)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="admin-appartamento" class="form-label">Appartamento</label><input id="admin-appartamento" type="text" class="form-input"></div>
                            <div class="form-group"><label for="admin-millesimi" class="form-label">Millesimi</label><input id="admin-millesimi" type="number" step="0.01" class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="admin-telefono" class="form-label">Telefono</label><input id="admin-telefono" type="tel" class="form-input"></div>
                        <div class="flex justify-end pt-2">
                           <button type="submit" class="btn btn-primary">Crea Utente</button>
                        </div>
                    </form>
                </div>

                <h2 class="section-title">Elenco Utenti Esistenti</h2>
                <div id="user-list-container" class="list-container">
                    <p>Caricamento utenti...</p>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderCurrentPage = () => {
            const app = document.getElementById('app');
            if (currentPage === 'login') {
                app.innerHTML = renderLoginPage();
                setupLoginHandlers();
                return;
            }
            app.innerHTML = `<div style="padding:1rem;">Caricamento...</div>`;
            const userType = userProfile?.tipoUtente;
            
            if (userType === 'custode' && currentPage === 'dashboard') currentPage = 'segnalazioni';

            let content = '';
            switch (currentPage) {
                case 'dashboard': content = renderDashboard(); break;
                case 'bacheca': content = renderBacheca(); break;
                case 'sondaggi': if (userType !== 'custode') { content = renderSondaggi(); } break;
                case 'segnalazioni': content = renderSegnalazioni(); break;
                case 'profilo': content = renderProfilo(); break;
                case 'infoUtili': content = renderInfoUtili(); break;
                case 'userManagement': 
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagement(); 
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppi();
                    else navigateTo('dashboard');
                    break;
                case 'importazione':
                    if (['supervisore', 'adm'].includes(userType)) content = renderImportazione();
                    else navigateTo('dashboard');
                    break;
                default: content = renderLoginPage();
            }

            app.innerHTML = content;

            switch (currentPage) {
                case 'bacheca': loadCommunications(); setupBachecaHandlers(); break;
                case 'sondaggi': if (userType !== 'custode') { loadPolls(); setupPollHandlers(); } break;
                case 'segnalazioni': loadReports(); setupReportHandlers(); break;
                case 'profilo': setupProfileHandlers(); break;
                case 'userManagement': if (['supervisore', 'adm'].includes(userType)) { loadUsers(); setupAdminUserCreationHandler(); } break;
                case 'gestioneGruppi': if (['supervisore', 'adm'].includes(userType)) { loadPartialCondos(); setupUserManagementHandlers(); } break;
                case 'importazione': if (['supervisore', 'adm'].includes(userType)) { setupImportazioneHandlers(); } break;
            }

            if (currentPage !== 'login') {
                checkForNewCommunications();
            }
        };

        // --- MODIFICA INIZIO: Logica di registrazione utente aggiornata ---
        const setupLoginHandlers = () => {
            let isRegistering = false;
            const toggleAuthBtn = document.getElementById("toggle-auth");
            const authTitle = document.getElementById("auth-title");
            const authSubmitBtn = document.getElementById("auth-submit");
            const registerFields = document.getElementById("register-fields");
            const authForm = document.getElementById("auth-form");
            const forgotPasswordBtn = document.getElementById("forgot-password");

            const nominativoInput = document.getElementById('nominativo-select');
            const propertySelectionWrapper = document.getElementById('property-selection-wrapper');
            const propertyItemsContainer = document.getElementById('property-items-container');
            const summaryEl = document.getElementById('selection-summary');

            let groupedProperties = {};
            let partialCondosList = [];

            const findHeader = (headers, keywords) => {
                const lowerCaseKeywords = keywords.map(k => k.toLowerCase());
                return headers.find(header => lowerCaseKeywords.includes(header.toLowerCase()));
            };

            const loadPartialCondosForRegistration = async () => {
                if (partialCondosList.length > 0) return;
                try {
                    const q = query(collection(db, "partialCondos"), orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    partialCondosList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Errore nel caricamento dei condomini parziali:", error);
                    partialCondosList = [];
                }
            };

            const getAutomaticGroup = (interno) => {
                if (!interno || partialCondosList.length === 0) return '';
                const lowerInterno = interno.toLowerCase();

                if (/\be\b|\be-/.test(lowerInterno)) {
                    const boxCondo = partialCondosList.find(c => c.name.toLowerCase() === 'box');
                    if (boxCondo) return boxCondo.name;
                }
                if (lowerInterno.includes('b11')) {
                    const b11Condo = partialCondosList.find(c => c.name.toLowerCase().includes('bellini 11'));
                    if (b11Condo) return b11Condo.name;
                }

                const sortedCondos = [...partialCondosList].sort((a, b) => b.name.length - a.name.length);
                for (const condo of sortedCondos) {
                    if (lowerInterno.includes(condo.name.toLowerCase())) {
                        return condo.name;
                    }
                }
                return '';
            };

            const loadPropertyDataForRegistration = async () => {
                try {
                    if (Object.keys(groupedProperties).length > 0) return;
                    const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) return;
                    
                    const tableData = querySnapshot.docs[0].data().tableData || [];
                    if (tableData.length === 0) return;

                    const headers = Object.keys(tableData[0]);
                    const nominativoHeader = findHeader(headers, ['nominativo']);
                    const apartmentHeader = findHeader(headers, ['interno', 'appartamento', 'unita']);
                    const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);

                    if (!nominativoHeader || !apartmentHeader || !millesimiHeader) {
                        console.error("Intestazioni non trovate! Assicurarsi che il file Excel contenga colonne per 'Nominativo', 'Interno' e 'Millesimi'.");
                        return;
                    }
                    
                    tableData.forEach(item => {
                        const nominativo = item[nominativoHeader];
                        if (!nominativo) return;
                        if (!groupedProperties[nominativo]) groupedProperties[nominativo] = [];
                        groupedProperties[nominativo].push({ apartment: item[apartmentHeader], millesimi: item[millesimiHeader] });
                    });
                    
                    const datalistEl = document.getElementById('nominativi-list');
                    datalistEl.innerHTML = Object.keys(groupedProperties).map(name => `<option value="${name}"></option>`).join('');
                    
                } catch (error) { console.error("Errore nel caricamento dati per la registrazione:", error); }
            };
            
            const updateSummary = () => {
                const propertyItems = propertyItemsContainer.querySelectorAll('.property-selection-item');
                const selectedProperties = [];

                propertyItems.forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox && !checkbox.checked) return;

                    const groupSelect = item.querySelector('.group-select');
                    selectedProperties.push({
                        apartment: item.dataset.apartment,
                        millesimi: parseFloat(item.dataset.millesimi) || 0,
                        group: groupSelect.value
                    });
                });

                if (selectedProperties.length === 0) {
                    summaryEl.innerHTML = '<span style="color:var(--warning);">Seleziona almeno una proprietà.</span>';
                    return;
                }

                let totalMillesimi = 0;
                let summaryHtml = '<strong>Unità Selezionate:</strong><ul>';
                selectedProperties.forEach(prop => {
                    summaryHtml += `<li style="list-style-type: disc; margin-left: 20px;">${prop.apartment} (${prop.millesimi.toFixed(2)} ‰) - <strong>Gruppo:</strong> ${prop.group || 'N/A'}</li>`;
                    totalMillesimi += prop.millesimi;
                });
                summaryHtml += `</ul><hr style="border-color: var(--surface-color); margin: 0.5rem 0;"><strong style="display: flex; justify-content: space-between;"><span>Totale Millesimi:</span><span>${totalMillesimi.toFixed(2)} ‰</span></strong>`;
                summaryEl.innerHTML = summaryHtml;
            };

            const handleNominativoSelection = async (event) => {
                const selectedName = event.target.value;
                const properties = groupedProperties[selectedName];
                
                propertyItemsContainer.innerHTML = '';
                propertySelectionWrapper.classList.add('hidden');
                summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';

                if (!properties) return;

                await loadPartialCondosForRegistration();
                const groupOptionsHtml = `<option value="">Nessun Gruppo</option>` + partialCondosList.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                properties.forEach((prop, index) => {
                    const autoGroup = getAutomaticGroup(prop.apartment);
                    const isMultiProperty = properties.length > 1;
                    
                    const item = document.createElement('div');
                    item.className = 'property-selection-item';
                    item.dataset.apartment = prop.apartment;
                    item.dataset.millesimi = prop.millesimi;

                    const labelHtml = `
                        <label for="prop-${index}">
                            ${isMultiProperty ? `<input type="checkbox" id="prop-${index}" style="width: 20px; height: 20px; accent-color: var(--accent-color);">` : ''}
                            <span>${prop.apartment} - ${prop.millesimi} ‰</span>
                        </label>
                    `;
                    const groupSelectorHtml = `<select class="form-select group-select">${groupOptionsHtml.replace(`value="${autoGroup}"`, `value="${autoGroup}" selected`)}</select>`;
                    
                    item.innerHTML = labelHtml + groupSelectorHtml;
                    propertyItemsContainer.appendChild(item);
                });

                propertySelectionWrapper.classList.remove('hidden');
                propertyItemsContainer.addEventListener('change', updateSummary);
                updateSummary();
            };

            nominativoInput?.addEventListener('input', handleNominativoSelection);

            toggleAuthBtn?.addEventListener("click", event => {
                event.preventDefault();
                isRegistering = !isRegistering;
                authTitle.textContent = isRegistering ? "Registrati" : "Accedi";
                authSubmitBtn.textContent = isRegistering ? "Registrati" : "Accedi";
                event.target.textContent = isRegistering ? "Hai già un account? Accedi" : "Non hai un account? Registrati";
                registerFields.classList.toggle("hidden", !isRegistering);
                forgotPasswordBtn.classList.toggle("hidden", isRegistering);
                if (isRegistering) {
                    loadPropertyDataForRegistration();
                }
            });

            authForm?.addEventListener("submit", async t => {
                t.preventDefault();
                const o = document.getElementById("email").value, n = document.getElementById("password").value, d = document.getElementById("error-message"), r = document.getElementById("success-message");
                d.style.display = "none"; r.style.display = "none";
                try {
                    if (isRegistering) {
                        const t = document.getElementById("confirm-password").value, i = document.getElementById("nome").value, s = document.getElementById("cognome").value, a = document.getElementById("tipo-utente").value, l = document.getElementById("telefono").value;
                        
                        if (n !== t) throw new Error("Le password non coincidono");
                        if (!i || !s || !a) throw new Error("Compila tutti i campi obbligatori.");

                        const propertiesForUser = [];
                        const propertyItems = propertyItemsContainer.querySelectorAll('.property-selection-item');
                        propertyItems.forEach(item => {
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            if (checkbox && !checkbox.checked) return;

                            const groupSelect = item.querySelector('.group-select');
                            propertiesForUser.push({
                                interno: item.dataset.apartment,
                                millesimi: parseFloat(item.dataset.millesimi) || 0,
                                gruppo: groupSelect.value || ''
                            });
                        });

                        if (propertiesForUser.length === 0) throw new Error("Seleziona almeno una unità immobiliare.");
                        
                        await register(o, n, { nome: i, cognome: s, tipoUtente: a, telefono: l, proprieta: propertiesForUser });
                        r.textContent = "Registrazione completata! Ora puoi accedere."; r.style.display = "block"; authForm.reset();
                        propertyItemsContainer.innerHTML = '';
                        propertySelectionWrapper.classList.add('hidden');
                        summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';

                    } else { await login(o, n); }
                } catch (p) { d.textContent = p.message; d.style.display = "block"; }
            });
            
            forgotPasswordBtn?.addEventListener("click", async t => {
                t.preventDefault(); const e = document.getElementById("email").value, o = document.getElementById("error-message"), n = document.getElementById("success-message");
                if (!e) return o.textContent = "Inserisci la tua email per reimpostare la password", void (o.style.display = "block");
                try { await resetPassword(e); n.textContent = "Email di reset password inviata!"; n.style.display = "block"; o.style.display = "none";
                } catch (d) { o.textContent = d.message; o.style.display = "block"; }
            });

            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget; const targetId = button.dataset.target; const passwordInput = document.getElementById(targetId);
                    const isPassword = passwordInput.type === 'password'; passwordInput.type = isPassword ? 'text' : 'password';
                    button.innerHTML = isPassword ? eyeSlashIcon : eyeIcon;
                });
            });
        };
        // --- MODIFICA FINE ---

        const setupBachecaHandlers=()=>{const e=document.getElementById("create-communication-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("comm-title"),n=document.getElementById("comm-content"),d=document.getElementById("publish-comm-btn"),i=o.value.trim(),r=n.value.trim();if(!i||!r)return alert("Compila titolo e messaggio.");d.disabled=!0,d.textContent="...";try{await addDoc(collection(db,"communications"),{title:i,content:r,createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()}),await logActivity("communication_posted",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:i}),e.reset()}catch(c){console.error("Errore:",c),alert("Si è verificato un errore.")}finally{d.disabled=!1,d.textContent="Pubblica"}})};
        const setupPollHandlers=()=>{const e=document.getElementById("create-poll-form");if(!e)return;const t=document.getElementById("poll-options-list"),o=document.getElementById("add-poll-option");function n(e=""){const o=document.createElement("div");o.className="flex items-center gap-2",o.innerHTML=`<input type="text" class="form-input" style="flex:1" required placeholder="Testo opzione" value="${e}"><button type="button" class="btn-remove-option" style="background:var(--surface-color-light); border:none; color:var(--primary-text); width:36px; height:36px; border-radius:50%; cursor:pointer;">−</button>`,o.querySelector(".btn-remove-option").onclick=()=>{t.removeChild(o),t.childElementCount<2&&n()},t.appendChild(o)}0===t.childElementCount&&(n(),n()),o.onclick=e=>{e.preventDefault(),n()},e.addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("poll-title").value,t=document.getElementById("poll-description").value,d=document.getElementById("poll-deadline").value,i=document.getElementById("poll-deadline-time").value,l=e.querySelectorAll('#poll-options-list input[type="text"]'),r=Array.from(l).map(e=>e.value.trim()).filter(Boolean).map(e=>({text:e,votes:0}));if(r.length<2)return alert("Inserisci almeno due opzioni.");if(!d||!i)return alert("Inserisci una data e un'ora di scadenza.");const c=`${d}T${i}`,s=new Date(c);try{await addDoc(collection(db,"polls"),{title:n,description:t,options:r,deadline:s,createdBy:userProfile.nome+" "+userProfile.cognome,createdById:currentUser.uid,createdAt:serverTimestamp(),voters:[]}),await logActivity("poll_created",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:n}),e.reset()}catch(p){console.error("Errore:",p)}}),e.addEventListener("reset",()=>{setTimeout(()=>{t.innerHTML="",n(),n()},0)})};
        const setupReportHandlers = () => { const e=document.getElementById("create-report-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("report-title").value,n=document.getElementById("report-description").value,i=document.getElementById("report-category").value,d=document.getElementById("report-priority").value,r=document.getElementById("report-location").value;if(!o||!n||!i||!d||!r)return alert("Compila tutti i campi.");const c={title:o,description:n,category:i,priority:d,location:r,status:"aperta",createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()},l=document.getElementById("report-recipient");l&&l.value?c.recipientType=l.value:c.recipientType="management";try{await addDoc(collection(db,"reports"),c),await logActivity("report_created",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:o,priority:d}),e.reset()}catch(a){console.error("Errore:",a)}})};
        const setupProfileHandlers=()=>{const e=document.getElementById("profile-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("profile-nome").value,n=document.getElementById("profile-cognome").value,d=document.getElementById("profile-telefono").value;try{await updateDoc(doc(db,"users",currentUser.uid),{nome:o,cognome:n,telefono:d}),await loadUserProfile(currentUser),showProfileMessage("success","Profilo aggiornato!")}catch(m){showProfileMessage("error",`Errore: ${m.message}`)}})};

        const setupImportazioneHandlers = async () => {
            // Riferimenti agli elementi DOM
            const savedDataView = document.getElementById('saved-data-view');
            const uploadView = document.getElementById('upload-view');
            const savedDataInfo = document.getElementById('saved-data-info');
            const savedDataTableContainer = document.getElementById('saved-data-table-container');
            const showUploadBtn = document.getElementById('show-upload-form-btn');

            const fileInput = document.getElementById('excel-file-input');
            const tableContainer = document.getElementById('excel-table-container');
            const messageBox = document.getElementById('message-import');
            const saveBtnContainer = document.getElementById('save-button-container');
            const saveBtn = document.getElementById('save-imported-data-btn');

            let jsonDataToSave = null;
            let fileNameToSave = '';

            // Funzione helper per generare una tabella HTML dai dati
            const generateTableHTML = (data) => {
                // Se i dati sono oggetti (da Firestore)
                if (data.length > 0 && typeof data[0] === 'object' && !Array.isArray(data[0])) {
                    const headers = Object.keys(data[0]);
                    let tableHTML = '<table class="data-table"><thead><tr>';
                    headers.forEach(h => tableHTML += `<th>${h}</th>`);
                    tableHTML += '</tr></thead><tbody>';
                    data.forEach(row => {
                        tableHTML += '<tr>';
                        headers.forEach(h => tableHTML += `<td>${row[h] !== undefined ? row[h] : ''}</td>`);
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    return tableHTML;
                }
                // Se i dati sono array di array (dall'anteprima file)
                if (data.length > 0 && Array.isArray(data[0])) {
                     const headers = data[0];
                    let tableHTML = '<table class="data-table"><thead><tr>';
                    headers.forEach(header => tableHTML += `<th>${header}</th>`);
                    tableHTML += '</tr></thead><tbody>';
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        tableHTML += '<tr>';
                        headers.forEach((_, colIndex) => {
                            const cellValue = row[colIndex] !== undefined ? row[colIndex] : '';
                            tableHTML += `<td>${cellValue}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                    tableHTML += '</tbody></table>';
                    return tableHTML;
                }
                return '<p>Nessun dato da visualizzare.</p>';
            };

            // Funzione per caricare i dati più recenti da Firestore
            const loadLatestData = async () => {
                const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const latestDoc = querySnapshot.docs[0].data();
                    const dateFormatted = latestDoc.uploadedAt.toDate().toLocaleString("it-IT", { dateStyle: 'long', timeStyle: 'short' });
                    
                    savedDataInfo.innerHTML = `<strong>File:</strong> ${latestDoc.fileName}<br><strong>Ultimo caricamento:</strong> ${dateFormatted}`;
                    savedDataTableContainer.innerHTML = generateTableHTML(latestDoc.tableData);
                    
                    savedDataView.classList.remove('hidden');
                    uploadView.classList.add('hidden');
                } else {
                    savedDataView.classList.add('hidden');
                    uploadView.classList.remove('hidden');
                }
            };
            
            // Logica per il pulsante "Carica Nuovo"
            showUploadBtn.addEventListener('click', () => {
                savedDataView.classList.add('hidden');
                uploadView.classList.remove('hidden');
            });

            // Logica per il caricamento del file (ANTEPRIMA)
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                jsonDataToSave = null; fileNameToSave = '';
                saveBtnContainer.classList.add('hidden'); messageBox.style.display = 'none';

                if (!file) {
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    return;
                }
                fileNameToSave = file.name;
                tableContainer.innerHTML = '<p>Caricamento in corso...</p>';

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        if (jsonData.length === 0) throw new Error("Il file Excel è vuoto.");
                        
                        jsonDataToSave = jsonData;
                        tableContainer.innerHTML = generateTableHTML(jsonData);
                        saveBtnContainer.classList.remove('hidden');
                    } catch (err) {
                         messageBox.className = 'message-box error';
                         messageBox.textContent = `Errore lettura file: ${err.message}`;
                         messageBox.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            // Logica per il salvataggio dei dati
            saveBtn.addEventListener('click', async () => {
                if (!jsonDataToSave || jsonDataToSave.length < 2) {
                    alert('Nessun dato valido da salvare.'); return;
                }
                saveBtn.disabled = true; saveBtn.textContent = 'Salvataggio...';

                const convertArrayOfArraysToObjects = (data) => {
                    const headers = data[0].map(h => h.toString().trim());
                    return data.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] !== undefined ? row[index] : '';
                        });
                        return obj;
                    });
                };
                const dataToSave = convertArrayOfArraysToObjects(jsonDataToSave);

                try {
                    await addDoc(collection(db, "importedData"), {
                        fileName: fileNameToSave,
                        tableData: dataToSave,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });
                    await logActivity("data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: fileNameToSave });
                    
                    // Resetta il form e ricarica la vista con i dati appena salvati
                    fileInput.value = '';
                    saveBtnContainer.classList.add('hidden');
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    await loadLatestData();
                    
                } catch (error) {
                    console.error("Errore salvataggio dati: ", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = 'Si è verificato un errore durante il salvataggio.';
                    messageBox.style.display = 'block';
                } finally {
                    saveBtn.disabled = false; saveBtn.textContent = 'Salva e Sostituisci Dati';
                }
            });

            // Carica i dati all'avvio
            await loadLatestData();
        };

        const setupUserManagementHandlers = () => {
            const form = document.getElementById('create-partial-condo-form');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('partial-condo-name');
                const name = nameInput.value.trim();
                if (!name) return;

                try {
                    await addDoc(collection(db, 'partialCondos'), {
                        name: name,
                        createdBy: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    await logActivity("partial_condo_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { name: name });
                    nameInput.value = '';
                } catch (error) {
                    console.error("Errore nella creazione del condominio parziale:", error);
                    alert("Si è verificato un errore.");
                }
            });
        };

        const setupAdminUserCreationHandler = () => {
            const form = document.getElementById('admin-create-user-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const profileData = {
                    nome: document.getElementById('admin-nome').value,
                    cognome: document.getElementById('admin-cognome').value,
                    tipoUtente: document.getElementById('admin-tipo-utente').value,
                    proprieta: [], // Inizialmente vuoto, da modificare manualmente se necessario
                    telefono: document.getElementById('admin-telefono').value
                };
                
                // Aggiungi proprietà se specificate
                const appartamento = document.getElementById('admin-appartamento').value;
                const millesimi = parseFloat(document.getElementById('admin-millesimi').value);
                if (appartamento && !isNaN(millesimi)) {
                    profileData.proprieta.push({ interno: appartamento, millesimi: millesimi, gruppo: '' });
                }

                const messageBox = document.getElementById('admin-create-user-message');
                messageBox.style.display = 'none';

                try {
                    if (!profileData.nome || !profileData.cognome || !profileData.tipoUtente) {
                        throw new Error('Nome, Cognome e Tipo Utente sono obbligatori.');
                    }
                    
                    await register(email, password, profileData);

                    messageBox.className = 'message-box success';
                    messageBox.textContent = `Utente ${email} creato con successo!`;
                    messageBox.style.display = 'block';
                    form.reset();
                } catch (error) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });
        };
        
        const loadPartialCondos = () => {
            const listEl = document.getElementById('partial-condos-list');
            if (!listEl) return;

            const q = query(collection(db, "partialCondos"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessun gruppo creato.</p>`;
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(docSnap => {
                    const condo = docSnap.data();
                    return `
                    <div class="list-item">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 14h-2v2h2v-2m4-4h-2v2h2V10m0-4h-2v2h2V6M12 2L2 7v13h20V7L12 2z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${condo.name}</div>
                        </div>
                        <div class="list-item-action">
                            <button onclick="deletePartialCondo('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>
                        </div>
                    </div>
                    `;
                }).join('');
            });
        };

        const deletePartialCondo = async (id) => {
            if (!confirm('Sei sicuro di voler eliminare questo gruppo? L\'azione è irreversibile.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'partialCondos', id));
                await logActivity("partial_condo_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedId: id });
            } catch (error) {
                console.error("Errore durante l'eliminazione:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };
        const showProfileMessage=(e,t)=>{const o=document.getElementById("profile-message");o&&(o.className=`message-box ${e}`,o.textContent=t,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3))};
        
        const showCommunicationDetail = async (commId) => {
            try {
                const commDoc = await getDoc(doc(db, "communications", commId));
                if (commDoc.exists()) {
                    const comm = commDoc.data();
                    const contentHtml = `<p>${comm.content.replace(/\n/g, '<br>')}</p>`;
                    showModal(comm.title, contentHtml);
                }
            } catch (error) {
                console.error("Errore nel caricare la comunicazione:", error);
            }
        };

        const loadCommunications = () => {
            const listEl = document.getElementById("communications-list");
            if (!listEl) return;
            const q = query(collection(db, "communications"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                listEl.innerHTML = snapshot.empty ? `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessuna comunicazione.</p>` : snapshot.docs.map(docSnap => {
                    const comm = docSnap.data();
                    if (!comm.createdAt) return "";
                    const dateFormatted = comm.createdAt.toDate().toLocaleString("it-IT", { day: "2-digit", month: "short", year: "numeric"});
                    return `
                    <div class="list-item" onclick="showCommunicationDetail('${docSnap.id}')">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${comm.title}</div>
                            <div class="subtitle">${comm.content.substring(0, 50)}...</div>
                            <div class="subtitle" style="font-size:0.75rem; margin-top:4px;">${comm.createdBy} - ${dateFormatted}</div>
                        </div>
                    </div>`;
                }).join("");
                if (currentPage === 'bacheca' && !snapshot.empty) {
                    localStorage.setItem(`lastSeenComm_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                    updateNotificationUI(false);
                }
            });
        };
        
        const showPollVoters = async (pollId) => {
            try {
                const pollDoc = await getDoc(doc(db, "polls", pollId));
                if (pollDoc.exists()) {
                    const poll = pollDoc.data();
                    let votersHtml;
                    if (poll.voters && poll.voters.length > 0) {
                        const totalVoters = poll.voters.length;
                        const totalMillesimi = poll.voters.reduce((sum, voter) => sum + (parseFloat(voter.millesimi) || 0), 0);

                        const summaryHtml = `
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>N. Condomini Votanti:</span><span>${totalVoters}</span></div>
                                <hr style="border:none; border-top: 1px solid var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Tot. Millesimi Votanti:</span><span>${totalMillesimi.toFixed(2)} ‰</span></div>
                            </div>
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Dettaglio per Condomino:</h4>
                        `;

                        const votersListHtml = poll.voters.map(voter => `
                            <div class="voter-item">
                                <span>${voter.name}</span>
                                <span style="color:var(--secondary-text); text-align:right;">
                                    <div>${voter.vote}</div>
                                    <div style="font-size:0.8rem">${(parseFloat(voter.millesimi) || 0).toFixed(2)} ‰</div>
                                </span>
                            </div>
                        `).join('');
                        votersHtml = summaryHtml + votersListHtml;
                    } else {
                        votersHtml = '<p>Nessun voto registrato per questo sondaggio.</p>';
                    }
                    showModal('Dettaglio Voti e Millesimi', votersHtml);
                }
            } catch (error) {
                console.error("Errore nel caricare i votanti:", error);
            }
        };

        const loadPolls = () => {
            const container = document.getElementById("polls-container");
            if (!container) return;
            const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                container.innerHTML = snapshot.empty ? `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessun sondaggio.</p>` : snapshot.docs.map(docSnap => {
                    const poll = docSnap.data();
                    if (!poll.deadline) return "";
                    const deadline = poll.deadline.toDate();
                    const isExpired = deadline < new Date();
                    const hasVoted = poll.voters && poll.voters.some(v => v.uid === currentUser.uid);
                    const totalVotes = poll.options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
                    
                    const showVotersButton = isExpired ? `<button onclick="showPollVoters('${docSnap.id}')" class="btn btn-secondary w-full mt-4">Mostra Votanti</button>` : '';

                    return `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <div class="list-item" style="padding:0; margin-bottom:1rem; cursor:default;">
                            <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                            <div class="list-item-content">
                                <div class="title">${poll.title}</div>
                                <div class="subtitle">${isExpired ? "Sondaggio chiuso" : "Sondaggio attivo"} ${hasVoted ? "· Hai votato" : ""}</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${poll.options.map((option, index) => {
                                const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                return `
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                        <span class="font-medium">${option.text}</span>
                                        <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                    </div>
                                    <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                    ${!isExpired && !hasVoted ? `<button onclick="voteOnPoll('${docSnap.id}', ${index})" class="btn btn-secondary" style="width:100%; margin-top:0.75rem;">Vota per "${option.text}"</button>` : ''}
                                </div>`
                            }).join("")}
                        </div>
                        ${showVotersButton}
                    </div>`;
                }).join("");
            });
        };

        const loadReports = () => {
            const mainContainer = document.getElementById('reports-main-container');
            const secondaryContainer = document.getElementById('reports-secondary-container');
            if (!mainContainer || !secondaryContainer) return;
            const renderReportCardHTML=(e,t)=>{if(!e.createdAt)return"";const o=e.createdAt.toDate().toLocaleString("it-IT",{day:"2-digit",month:"short"});const a=["amministratore","custode","consigliere","fornitore","supervisore", "adm"].includes(userProfile?.tipoUtente);const n=a,d="management"===e.recipientType&&n||e.recipientType===userProfile?.tipoUtente||"consigliere"===e.recipientType&&"consigliere"===userProfile?.tipoUtente;return`<div class="list-item"><div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div><div class="list-item-content"><div class="title">${e.title}</div><div class="subtitle" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.25rem;"><span class="badge ${getPriorityColor(e.priority)}">${e.priority}</span><span class="badge ${getStatusColor(e.status)}">${e.status}</span></div></div>${a&&"chiusa"!==e.status&&d?`<div class="list-item-action"><button onclick="updateReportStatus('${t}','${"aperta"===e.status?"in-corso":"chiusa"}')" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.8rem;">${"aperta"===e.status?"Prendi":"Chiudi"}</button></div>`:""}</div>`};
            const renderSnapshot=(e,t,o)=>{if(t.empty)return void(e.innerHTML=`<p style="color:var(--secondary-text); padding: 1rem 0;">${o}</p>`);const a=t.docs.sort((e,t)=>{const o=e.data().createdAt?.toMillis()||0,n=t.data().createdAt?.toMillis()||0;return n-o});e.innerHTML=a.map(e=>renderReportCardHTML(e.data(),e.id)).join("")};
            const userType=userProfile.tipoUtente,userId=currentUser.uid,qSent=query(collection(db,"reports"),where("createdById","==",userId));onSnapshot(qSent,s=>renderSnapshot(secondaryContainer,s,"Non hai inviato segnalazioni."));let qToManage;if(["amministratore","custode","consigliere","fornitore", "supervisore", "adm"].includes(userType)){qToManage=query(collection(db,"reports"),orderBy("createdAt","desc"));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione ricevuta."))}else{qToManage=query(collection(db,"reports"),where("recipientType","in",["management","condomino"]));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione pubblica."))}
        };

        const loadUsers = async () => {
            const container = document.getElementById('user-list-container');
            if (!container) return;
            if (!['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                container.innerHTML = '<p>Accesso non autorizzato.</p>';
                return;
            }
            try {
                const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("cognome")));
                if (usersSnapshot.empty) {
                    container.innerHTML = '<p>Nessun utente trovato.</p>';
                } else {
                    container.innerHTML = usersSnapshot.docs.map(docSnap => {
                        const user = docSnap.data();
                        const userId = docSnap.id;
                        const propertiesHtml = user.proprieta && user.proprieta.length > 0
                            ? user.proprieta.map(p => `<li>${p.interno}: ${p.millesimi.toFixed(2)} ‰ ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')
                            : '<li>Nessuna proprietà</li>';
                        
                        return `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div class="list-item" style="padding:0; cursor:default;">
                                <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg></div>
                                <div class="list-item-content">
                                    <div class="title">${user.nome} ${user.cognome}</div>
                                    <div class="subtitle">${user.email} - ${user.tipoUtente}</div>
                                </div>
                            </div>
                            <div style="padding-left: 64px; margin-top: 1rem; font-size: 0.9rem;">
                                <strong class="form-label" style="color:var(--primary-text);">Proprietà e Millesimi:</strong>
                                <ul style="list-style-type: disc; margin-left: 20px; color: var(--secondary-text);">
                                   ${propertiesHtml}
                                </ul>
                                <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(user.millesimiTotali || 0).toFixed(2)} ‰</span></div>
                            </div>
                        </div>`;
                    }).join("");
                }
            } catch (error) {
                console.error("Errore nel caricare gli utenti:", error);
                container.innerHTML = '<p>Errore nel caricamento degli utenti.</p>';
            }
        };

        const voteOnPoll=async(e,t)=>{try{const o=doc(db,"polls",e),n=await getDoc(o);if(!n.exists())return;const i=n.data();if(i.deadline.toDate()<new Date)return alert("Sondaggio scaduto.");if(i.voters?.some(e=>e.uid===currentUser.uid))return alert("Hai già votato!");const d=[...i.options];d[t].votes=(d[t].votes||0)+1;const a=i.options[t].text;const userMillesimi=userProfile?.millesimiTotali||0;const r=[...i.voters||[],{uid:currentUser.uid,name:`${userProfile.nome} ${userProfile.cognome}`,vote:a,millesimi:userMillesimi}];await updateDoc(o,{options:d,voters:r}),await logActivity("poll_voted",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{pollTitle:i.title,option:a})}catch(l){console.error("Errore nel voto:",l)}};

        const updateReportStatus=async(e,t)=>{try{await updateDoc(doc(db,"reports",e),{status:t,updatedAt:serverTimestamp()}),await logActivity("report_updated",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{reportId:e,newStatus:t})}catch(o){console.error("Errore nell'aggiornamento:",o)}};
        const updateNotificationUI=e=>{const t=document.getElementById("bacheca-notification-badge");t?.classList.toggle("hidden",!e)};
        const checkForNewCommunications=()=>{if(!currentUser||"custode"===userProfile?.tipoUtente)return;communicationsListener&&communicationsListener();const e=parseInt(localStorage.getItem(`lastSeenComm_${currentUser.uid}`),10)||0,t=new Date(e),o=query(collection(db,"communications"),where("createdAt",">",t));communicationsListener=onSnapshot(o,e=>{updateNotificationUI(!e.empty)})};
        
        window.navigateTo = navigateTo;
        window.logout = logout;
        window.voteOnPoll = voteOnPoll;
        window.updateReportStatus = updateReportStatus;
        window.showCommunicationDetail = showCommunicationDetail;
        window.showPollVoters = showPollVoters;
        window.deletePartialCondo = deletePartialCondo;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user);
                const userType = userProfile?.tipoUtente;
                let landingPage = 'dashboard';
                if (userType === 'custode') landingPage = 'segnalazioni';
                navigateTo(currentPage === 'login' || !currentPage ? landingPage : currentPage);
            } else {
                if (communicationsListener) communicationsListener();
                currentUser = null; userProfile = null;
                navigateTo('login');
            }
        });
    </script>
</body>
</html>
